<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html> <head>
<title>Test Pilot Debug Page</title>
<script src="experiment-page.js" type="application/javascript;version=1.8"></script>
<script type="application/javascript;version=1.8">

  function getEid() {
    return parseInt(document.getElementById("eid-input").value);
  }

  function setTaskStatus() {
    Components.utils.import("resource://testpilot/modules/setup.js");
    var newStatus = document.getElementById("status-code").value;
    newStatus = parseInt(newStatus);
    var task = TestPilotSetup.getTaskById(getEid());
    task.changeStatus(newStatus, false);
  }

  function reloadAllExperiments() {
    Components.utils.import("resource://testpilot/modules/setup.js");
    TestPilotSetup.reloadRemoteExperiments();
  }

  function runUnitTests() {
    Components.utils.import("resource://testpilot/tests/test_data_store.js");
    runAllTests();
  }

  function remindMe() {
    Components.utils.import("resource://testpilot/modules/setup.js");
    TestPilotSetup._notifyUserOfTasks(3);
    //TestPilotSetup._doHousekeeping();
  }

  function getCodeStorage() {
    Components.utils.import("resource://testpilot/modules/setup.js");
    var loader = TestPilotSetup._loader;
    var module = loader.require("remote-experiment-loader");
    return new module.PreferencesStore("extensions.testpilot.experiment.codeFs");
  }

  function getSelectedFilename() {
    var selector = document.getElementById("file-selector");
    var i = selector.selectedIndex;
    return selector.options[i].text;
  }

  function loadExperimentCode() {
    var filename = getSelectedFilename();
    var textArea = document.getElementById("experiment-code-area");
    prefStore = getCodeStorage();
    code = prefStore.getFile(filename).contents;
    textArea.value = code;
  }

  function saveAndRun() {
    var filename = getSelectedFilename();
    var textArea = document.getElementById("experiment-code-area");
    prefStore = getCodeStorage();
    code = prefStore.setFile(filename, textArea.value);
    reloadAllExperiments(function(success) {
      document.getElementById("debug").innerHTML = "Success? " + success;});
  }

  function showMetaData() {
    Components.utils.import("resource://testpilot/modules/setup.js");
    let task = TestPilotSetup.getTaskById(getEid());
    let csv = task._prependMetadataToCSV();
    document.getElementById("debug").innerHTML = "<pre>" + csv + "</pre>";
  }

  function makeThereBeAPopup() {
    Components.utils.import("resource://testpilot/modules/setup.js");
    var task = TestPilotSetup.getTaskById(getEid());
    var text = "Sample popup for " + task.title;
    TestPilotSetup._showNotification(task, false, text, "This is Title",
                                     "", true, true, "Linktext", "http://evilbrainjono.net");
  }

  function wipeDb() {
    Components.utils.import("resource://testpilot/modules/setup.js");
    var task = TestPilotSetup.getTaskById(getEid());
    task.dataStore.wipeAllData();
    var debug = document.getElementById("debug");
    debug.innerHTML = "Wiped!";
  }

  function nukeDb() {
    Components.utils.import("resource://testpilot/modules/setup.js");
    var task = TestPilotSetup.getTaskById(getEid());
    task.dataStore.nukeTable();
    var debug = document.getElementById("debug");
    debug.innerHTML = "Nuked!";
  }

  function populateFileDropdown() {
    Components.utils.import("resource://testpilot/modules/setup.js");
    var loader = TestPilotSetup._remoteExperimentLoader;
    var files = loader._codeStorage.listAllFiles();
    var selector = document.getElementById("file-selector");
    var opt;
    for (var i = 0; i < files.length; i++) {
      opt = document.createElement("option");
      opt.innerHTML = files[i];
      selector.appendChild(opt);
    }
  }

</script>

<style type="text/css">
      canvas { border: 1px solid black; }
    </style>

</head>

<body onload="populateFileDropdown();">
<p>Experiment number <input type="text" id="eid-input" value="1"></input></p>
<p><button onclick="showRawData(1);">Show Raw Data</button>
<button onclick="wipeDb();">Wipe My Data</button>
<button onclick="nukeDb();">NUKE</button>
<button onclick="uploadData();">Upload My Data</button>
<button onclick="makeThereBeAPopup();">Popup</button>
<button onclick="reloadAllExperiments();">Reload All Experiments</button>
<button onclick="runUnitTests();">Run Unit Tests</button>
<button onclick="remindMe();">Remind Me</button>
<input type="text" id="status-code"/><button onclick="setTaskStatus();">Set</button>
<button onclick="showMetaData();">Show Metadata</button>
</p>
<p><span id="debug"></span></p>


<textarea id="experiment-code-area" rows="40" cols="80">
</textarea>
<select id="file-selector"></select>
<button onclick="loadExperimentCode();">Load Ye Code</button>
<button onclick="saveAndRun();">Save And Run Ye Code</button>


</body> </html>
